name: Fraud Detection CI/CD

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 0 1 * *'  # Run monthly on the 1st day of the month

jobs:

  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        lfs: true
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.9
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    - name: Inspect dataset
      run: |
        python - <<'PY'
        import pandas as pd
        import os, sys
        p = 'data/creditcard.csv'
        print('Exists:', os.path.exists(p), 'Size:', os.path.getsize(p) if os.path.exists(p) else 'NA')
        df = pd.read_csv(p, nrows=5)
        print('Columns:', df.columns.tolist())
        print(df.head(2).to_string(index=False))
        PY
    - name: Train and evaluate model
      env:
        DATA_PATH: ${{ github.workspace }}/data/creditcard.csv
        MODEL_SAVE_PATH: ${{ github.workspace }}/model/saved_models/model.pkl
      run: |
        python model/model.py
    - name: Upload model artifacts
      uses: actions/upload-artifact@v4
      with:
        name: model-artifacts
        path: |
          model/saved_models/model.pkl
          mlruns/

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        lfs: true
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.9
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    - name: Download model artifacts
      uses: actions/download-artifact@v4
      with:
        name: model-artifacts
        path: .
    - name: Build Docker image
      run:  docker build -f api/Dockerfile -t fraud-detection-app .
    - name: Deploy to VPS
      env:
        VPS_HOST: ${{ secrets.VPS_HOST }}
        VPS_USER: ${{ secrets.VPS_USER }}
        VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
      run: |
        docker save fraud-detection-app | bzip2 | ssh $VPS_USER@$VPS_HOST 'bunzip2 | docker load'
        ssh $VPS_USER@$VPS_HOST 'docker run -d --rm --name fraud-detection-app -p 8000:8000 fraud-detection-app'
